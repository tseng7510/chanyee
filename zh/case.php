<!DOCTYPE html>
<html lang="en">

<head>
  <?php include('include_head.php'); ?>
  <link rel="stylesheet" type="text/css" href="../css/case.css">
</head>

<body>
  <?php include('include_body_top.php'); ?>
  <div class="wrapper innerPage">
    <header class="siteHeader" itemscope="itemscope" itemtype="https://schema.org/WPHeader">
      <?php include('include_top.php'); ?>
    </header>



    <main class="siteMain" aria-label="main" itemscope>

      <div class="mainBox">
        <div class="container">
          <div class="pageContent">

            <div class="case">
              <div class="box">
                <div class="swiper">
                  <div class="swiper-wrapper">

                    <div class="swiper-slide">
                      <div class="year">2002</div>
                      <div class="title">深居</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2002</div>
                      <div class="title">難得I</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2003</div>
                      <div class="title">知音少</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2003</div>
                      <div class="title">無為</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2004</div>
                      <div class="title">難得II</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2004</div>
                      <div class="title">聞道</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2004</div>
                      <div class="title">法國森居</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2005</div>
                      <div class="title">清風明月</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2006</div>
                      <div class="title">雲那裡</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2007</div>
                      <div class="title">山知道</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2008</div>
                      <div class="title">月未央</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2009</div>
                      <div class="title">貳拾方</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2010</div>
                      <div class="title">聽河的院子</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2011</div>
                      <div class="title">天台的月光</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2012</div>
                      <div class="title">老樣子</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2013</div>
                      <div class="title">坐賞雨時晴</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2014</div>
                      <div class="title">淡如菊</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2015</div>
                      <div class="title">十餘畝</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2019</div>
                      <div class="title">樹央央I</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>
                    <div class="swiper-slide">
                      <div class="year">2019</div>
                      <div class="title">樹央央II</div>
                      <div class="pic">
                        <img src="../images/in/project_01_000.jpg" alt="" />
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </main>





    <?php include('include_footer.php'); ?>
  </div>
  <?php include('include_body_bottom.php'); ?>
  
  <script>
    (function() {

      //swiper設定
      const swiper = new Swiper(".swiper", {
        direction: "vertical",
        allowTouchMove: false,
        slidesPerView: "auto",
        centeredSlides: true,
        spaceBetween: 50,
        speed: 800,
      });
      //swiper設定

      //抓取資料
      const caseBox = document.querySelector(".case");
      const heardBox = document.querySelector(".siteHeader");
      let caseHeight = caseBox.offsetHeight;
      const sideBox = document.createElement("div");
      sideBox.className = "sideBox";
      const sideBoxUl = document.createElement("ul");
      sideBox.append(sideBoxUl);

      const list = document.querySelectorAll(".swiper .swiper-slide");
      let data = [];
      list.forEach((item, index) => {
        data.push({
          year: item.querySelector(".year").innerText,
          title: [item.querySelector(".title").innerText]
        });
      });
      //抓取資料

      //將資料整理並新增側欄
      function organizeSteps(array) {
        let currentYear = "";
        let currentTitle = null;
        let result = [];

        array.forEach((item) => {
          if (item.year === currentYear) {
            currentTitle.push(item.title);
          } else {
            if (currentTitle !== null) {
              result.push({
                title: currentTitle,
                year: currentYear
              });
            }
            currentYear = item.year;
            currentTitle = item.title;
          }
        });

        if (currentTitle !== null) {
          result.push({
            title: currentTitle,
            year: currentYear
          });
        }

        return result;
      }

      let content = "";
      const organizedData = organizeSteps(data);

      organizedData.forEach((item, index) => {
        if (item.title.length > 1) {
          let inData = "";
          item.title.forEach((v) => {
            inData += `<li><div class="year">${item.year}</div><div class="title">${v}</div></li>`;
          });
          content += `<li class="item"><ul>${inData}</ul></li>`;
        } else {
          content += `<li class="item"><ul><li><div class="year">${item.year}</div><div class="title">${item.title}</div></li></ul></li>`;
        }
      });
      sideBoxUl.innerHTML = content;
      caseBox.append(sideBox);
      //將資料整理並新增側欄

      const sideBoxLi = document.querySelectorAll(".sideBox ul ul li");
      let checkHeight;
      let listLiHeight = 100;
      let sideLiHeight = [];
      let startY = 0;

      //判斷滾輪方向
      window.addEventListener("touchstart", function(e) {
        startY = e.touches[0].clientY * -1;
      });
      //判斷滾輪方向

      //初始側欄位置
      const options = {
        box: 'border-box', //content-box/border-box
      }

      const callback = (entries) => {
        startY = 0; //重置滾輪判斷位置

        caseHeight = caseBox.offsetHeight;
        let ww = entries[0].contentRect.width


        //一般狀態的高度
        if (ww > 1000) {
          listLiHeight = 100;
        } else if (ww <= 1000 && ww > 800) {
          listLiHeight = 60;
        } else if (ww <= 800) {
          listLiHeight = 80;
        }

        //active時的高度
        if (ww > 1400) {
          checkHeight = 100;
        } else if (ww <= 1400 && ww > 1000) {
          checkHeight = 80;
        } else if (ww <= 1000 && ww > 500) {
          checkHeight = 470;
        } else if (ww <= 500) {
          checkHeight = 250;
        }


        sideLiHeight = [];

        sideBoxLi.forEach((e, i) => {
          sideLiHeight.push(listLiHeight * i);
        });

        if (sideBoxUl.dataset.pastDate !== undefined) {
          console.log(sideLiHeight);
          console.log(sideLiHeight[sideBoxUl.dataset.pastDate]);
          sideBoxUl.style.transform = `translateY(${caseHeight / 2 - sideLiHeight[sideBoxUl.dataset.pastDate] - checkHeight / 2}px)`
        } else {
          sideBoxUl.style.transform = `translateY(${caseHeight / 2 - checkHeight / 2}px)`;
        }
      }
      const observer = new ResizeObserver(callback);
      const body = document.querySelector('body');
      observer.observe(body, options);
      //初始側欄位置

      //捲動側欄
      let count = 0;
      sideBoxLi[0].classList.add("active");


      let checkDebounce = 0;

      function debounce(func, delay) {
        let timeoutId;

        return function() {
          const context = this;
          const args = arguments;

          if (checkDebounce === 0) {
            checkDebounce++;
            func.apply(context, args);
            timeoutId = setTimeout(function() {
              checkDebounce = 0;
            }, delay);
          }
        };
      }



      let wheelSlide = function(e) {

        caseHeight = caseBox.offsetHeight;
        let deltaY = e.deltaY || e.touches[0].clientY * -1;
        const listLength = list.length;
        if (deltaY > startY && count < listLength - 1) {
          count++;
          swiper.slideNext();

        } else if (deltaY < startY && count > 0) {
          count--;
          swiper.slidePrev();
        }
        sideBoxUl.style.transform = `translateY(${caseHeight / 2 - sideLiHeight[count] - checkHeight / 2}px)`;
        sideBoxUl.dataset.pastDate = `${count}`

        sideBoxLi.forEach((e) => e.classList.remove("active"));
        sideBoxLi[count]?.classList.add("active");
      };

      const debouncedResize = debounce(wheelSlide, 1500);

      window.addEventListener("wheel", debouncedResize);
      window.addEventListener("touchmove", debouncedResize);
      //捲動側欄

    })();
  </script>
</body>

</html>